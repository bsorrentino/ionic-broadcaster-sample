"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_array_1 = require("@ionic/utils-array");
const utils_fs_1 = require("@ionic/utils-fs");
const Debug = require("debug");
const path = require("path");
const guards_1 = require("../../../guards");
const color_1 = require("../../color");
const errors_1 = require("../../errors");
const debug = Debug('ionic:lib:cordova:project');
const CORDOVA_ANDROID_PACKAGE_PATH = 'platforms/android/app/build/outputs/apk/';
const CORDOVA_IOS_SIMULATOR_PACKAGE_PATH = 'platforms/ios/build/emulator';
const CORDOVA_IOS_DEVICE_PACKAGE_PATH = 'platforms/ios/build/device';
async function getPlatforms(projectDir) {
    const platformsDir = path.resolve(projectDir, 'platforms');
    const contents = await utils_fs_1.readdirSafe(platformsDir);
    const platforms = await utils_array_1.filter(contents, async (file) => {
        const stat = await utils_fs_1.statSafe(path.join(platformsDir, file));
        return !file.startsWith('.') && typeof stat !== 'undefined' && stat.isDirectory();
    });
    return platforms;
}
exports.getPlatforms = getPlatforms;
async function getAndroidBuildOutputJson(p) {
    try {
        const json = await utils_fs_1.readJson(p);
        if (guards_1.isCordovaAndroidBuildOutputFile(json)) {
            return json;
        }
        else {
            debug('Output file does not match expected format: %O', json);
        }
    }
    catch (e) {
        debug('Error parsing file %O: %O', p, e);
    }
    throw new errors_1.FatalException(`Could not parse build output file: ${p}`);
}
exports.getAndroidBuildOutputJson = getAndroidBuildOutputJson;
/**
 * Get the relative path to most recently built APK or IPA file
 */
async function getPackagePath(root, appName, platform, { emulator = false, release = false } = {}) {
    if (platform === 'android') {
        const outputPath = path.resolve(root, CORDOVA_ANDROID_PACKAGE_PATH, release ? 'release' : 'debug');
        const outputJsonPath = path.resolve(outputPath, 'output.json');
        const outputJson = await getAndroidBuildOutputJson(outputJsonPath);
        // TODO: handle multiple files from output.json, prompt to select?
        return path.relative(root, path.resolve(outputPath, outputJson[0].path));
    }
    else if (platform === 'ios') {
        if (emulator) {
            return path.join(CORDOVA_IOS_SIMULATOR_PACKAGE_PATH, `${appName}.app`);
        }
        return path.join(CORDOVA_IOS_DEVICE_PACKAGE_PATH, `${appName}.ipa`);
    }
    throw new errors_1.FatalException(`Unknown package path for ${color_1.input(appName)} on ${color_1.input(platform)}.`);
}
exports.getPackagePath = getPackagePath;
